<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Licitacoes</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const Search = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const Plus = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );

        const X = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const AlertCircle = () => (
            <svg className="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const Building2 = () => (
            <svg className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
        );

        const FileText = () => (
            <svg className="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );

        const Calendar = () => (
            <svg className="w-5 h-5 text-orange-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );

        const MapPin = () => (
            <svg className="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const Link = () => (
            <svg className="w-5 h-5 text-purple-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
        );

        function EmailAnalyzer() {
            const [emailText, setEmailText] = useState('');
            const [keywords, setKeywords] = useState(['licitacao', 'pregao', 'tomada de preco', 'concorrencia', 'dispensa']);
            const [newKeyword, setNewKeyword] = useState('');
            const [opportunities, setOpportunities] = useState([]);
            const [hasAnalyzed, setHasAnalyzed] = useState(false);
            const [debugMode, setDebugMode] = useState(false);

            const addKeyword = () => {
                if (newKeyword.trim() && !keywords.includes(newKeyword.trim().toLowerCase())) {
                    setKeywords([...keywords, newKeyword.trim().toLowerCase()]);
                    setNewKeyword('');
                }
            };

            const removeKeyword = (keyword) => {
                setKeywords(keywords.filter(k => k !== keyword));
            };

            const analyzeEmail = () => {
                if (!emailText.trim()) {
                    setOpportunities([]);
                    setHasAnalyzed(false);
                    return;
                }

                const text = emailText;
                const found = [];
                const sections = text.split(/(?=Objeto:)/gi);

                sections.forEach((section, index) => {
                    if (!section.trim()) return;

                    const hasKeyword = keywords.some(keyword => 
                        section.toLowerCase().includes(keyword.toLowerCase())
                    );

                    if (!hasKeyword) return;

                    const extractValue = (fieldName) => {
                        // Padrão 1: Campo e valor na mesma linha ou valor na linha seguinte
                        const patterns = [
                            // Valor na linha seguinte (Campo:\n Valor)
                            new RegExp(`${fieldName}:\\s*\\n([^\\n]+)`, 'i'),
                            // Valor na mesma linha
                            new RegExp(`${fieldName}[:\\s]+([^\\n]+)`, 'i')
                        ];
                        
                        for (const pattern of patterns) {
                            const match = section.match(pattern);
                            if (match && match[1] && match[1].trim()) {
                                const value = match[1].trim().replace(/\s+/g, ' ');
                                // Evita pegar campos vazios ou próximos campos
                                if (value && !value.match(/^[A-Z][a-záàâãéèêíïóôõöúç\s]+:$/i)) {
                                    return value;
                                }
                            }
                        }
                        return null;
                    };

                    let orgao = extractValue('Órgão Licitante') || 
                                extractValue('Orgao Licitante') ||
                                extractValue('Entidade');
                    
                    if (!orgao) {
                        const orgaoPatterns = [
                            /(Prefeitura[^\n]+)/i,
                            /(Camara[^\n]+)/i,
                            /(Câmara[^\n]+)/i,
                            /(Secretaria[^\n]+)/i,
                            /(Tribunal[^\n]+)/i,
                            /(Instituto[^\n]+)/i,
                            /(Servico[^\n]+)/i,
                            /(Serviço[^\n]+)/i,
                            /(Ministerio[^\n]+)/i,
                            /(Ministério[^\n]+)/i,
                            /(Governo[^\n]+)/i,
                            /(Autarquia[^\n]+)/i,
                            /(CEPAL)/i,
                            /(Companhia[^\n]+)/i
                        ];
                        
                        for (const pattern of orgaoPatterns) {
                            const match = section.match(pattern);
                            if (match) {
                                orgao = match[1].trim();
                                break;
                            }
                        }
                    }

                    let objeto = extractValue('Objeto');
                    
                    let prazo = extractValue('Prazo Abertura') || 
                                extractValue('Prazo') ||
                                extractValue('Data de Abertura');
                    
                    if (!prazo) {
                        const dateMatch = section.match(/(\d{2}\/\d{2}\/\d{4})/);
                        if (dateMatch) {
                            prazo = dateMatch[1];
                            const timeMatch = section.match(/(\d{2}:\d{2})/);
                            if (timeMatch) {
                                prazo += ' ' + timeMatch[1];
                            }
                        }
                    }

                    let cidade = extractValue('Cidade');
                    
                    if (!cidade) {
                        const ufMatch = section.match(/UF[:\s]+([A-Z]{2})/i);
                        if (ufMatch) {
                            const cidadeMatch = section.match(/Cidade[:\s]+([^\n]+?)\s+UF/i);
                            if (cidadeMatch) {
                                cidade = cidadeMatch[1].trim() + ' - ' + ufMatch[1];
                            } else {
                                cidade = ufMatch[1];
                            }
                        }
                    }

                    // Extrair link do edital da seção Acesso ou Observações
                    let editalLink = null;
                    
                    // Primeiro tenta na seção Acesso
                    const acessoMatch = section.match(/Acesso:\s*([\s\S]*?)(?=Observa[çc][õo]es:|Data Cadastro:|$)/i);
                    if (acessoMatch) {
                        const acessoSection = acessoMatch[1];
                        const lines = acessoSection.split('\n').map(l => l.trim()).filter(l => l);
                        for (let i = 0; i < lines.length; i++) {
                            if (lines[i].toUpperCase().includes('ARQUIVO DO EDITAL')) {
                                // Pega o link da linha anterior
                                for (let j = i - 1; j >= 0 && j >= i - 2; j--) {
                                    const urlMatch = lines[j].match(/(https?:\/\/[^\s]+)/);
                                    if (urlMatch) {
                                        editalLink = urlMatch[1];
                                        break;
                                    }
                                }
                                if (editalLink) break;
                            }
                        }
                        // Fallback: pega link do PNCP na seção Acesso
                        if (!editalLink) {
                            const pncpMatch = acessoSection.match(/(https?:\/\/pncp\.gov\.br[^\s]+)/);
                            if (pncpMatch) {
                                editalLink = pncpMatch[1];
                            }
                        }
                    }
                    
                    // Se não achou na seção Acesso, busca nas Observações
                    if (!editalLink) {
                        const obsMatch = section.match(/Observa[çc][õo]es:\s*([\s\S]*?)(?=Data Cadastro:|$)/i);
                        if (obsMatch) {
                            const obsSection = obsMatch[1];
                            // Procura link de edital do gov.br/compras
                            const editalGovMatch = obsSection.match(/(https?:\/\/www\.gov\.br\/compras\/edital[^\s;]+)/);
                            if (editalGovMatch) {
                                editalLink = editalGovMatch[1];
                            }
                            // Fallback: link do PNCP nas observações
                            if (!editalLink) {
                                const pncpMatch = obsSection.match(/(https?:\/\/pncp\.gov\.br[^\s;]+)/);
                                if (pncpMatch) {
                                    editalLink = pncpMatch[1];
                                }
                            }
                        }
                    }

                    found.push({
                        id: index,
                        rawText: section.substring(0, 500) + (section.length > 500 ? '...' : ''),
                        orgao: orgao || 'Nao identificado',
                        objeto: objeto || 'Nao identificado',
                        prazo: prazo || 'Nao identificado',
                        cidade: cidade || 'Nao identificado',
                        editalLink: editalLink,
                        fullSection: section
                    });
                });

                setOpportunities(found);
                setHasAnalyzed(true);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                Analisador de Oportunidades em Email
                            </h1>
                            <p className="text-gray-600">
                                Cole o conteudo do email e identifique licitacoes com informacoes estruturadas
                            </p>
                        </div>

                        <div className="grid md:grid-cols-3 gap-6">
                            <div className="md:col-span-1">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <Search />
                                        Palavras-chave
                                    </h2>
                                    
                                    <div className="mb-4">
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={newKeyword}
                                                onChange={(e) => setNewKeyword(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && addKeyword()}
                                                placeholder="Nova palavra-chave"
                                                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            />
                                            <button
                                                onClick={addKeyword}
                                                className="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-colors"
                                            >
                                                <Plus />
                                            </button>
                                        </div>
                                    </div>

                                    <div className="space-y-2">
                                        {keywords.map((keyword) => (
                                            <div
                                                key={keyword}
                                                className="flex items-center justify-between bg-blue-50 px-3 py-2 rounded-lg"
                                            >
                                                <span className="text-gray-700">{keyword}</span>
                                                <button
                                                    onClick={() => removeKeyword(keyword)}
                                                    className="text-red-500 hover:text-red-700"
                                                >
                                                    <X />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="md:col-span-2">
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4">
                                        Conteudo do Email
                                    </h2>
                                    <textarea
                                        value={emailText}
                                        onChange={(e) => setEmailText(e.target.value)}
                                        placeholder="Cole aqui o conteudo do email com as licitacoes..."
                                        className="w-full h-64 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-sm"
                                    />
                                    <button
                                        onClick={analyzeEmail}
                                        className="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold"
                                    >
                                        Analisar Email
                                    </button>
                                    <label className="mt-2 flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={debugMode}
                                            onChange={(e) => setDebugMode(e.target.checked)}
                                            className="rounded"
                                        />
                                        Modo debug (mostrar texto bruto analisado)
                                    </label>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4">
                                        Oportunidades Identificadas
                                        {hasAnalyzed && (
                                            <span className="ml-2 text-sm font-normal text-gray-600">
                                                ({opportunities.length} encontrada{opportunities.length !== 1 ? 's' : ''})
                                            </span>
                                        )}
                                    </h2>

                                    {!hasAnalyzed ? (
                                        <div className="text-center py-12 text-gray-500">
                                            <AlertCircle />
                                            <p>Cole um email e clique em "Analisar Email" para comecar</p>
                                        </div>
                                    ) : opportunities.length === 0 ? (
                                        <div className="text-center py-12 text-gray-500">
                                            <AlertCircle />
                                            <p>Nenhuma oportunidade encontrada com as palavras-chave definidas</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {opportunities.map((opp, idx) => (
                                                <div
                                                    key={opp.id}
                                                    className="border-2 border-gray-200 rounded-lg p-5 hover:shadow-lg transition-shadow bg-gradient-to-br from-white to-gray-50"
                                                >
                                                    <div className="mb-4 pb-3 border-b border-gray-200">
                                                        <span className="text-sm font-bold text-indigo-600">
                                                            Oportunidade #{idx + 1}
                                                        </span>
                                                    </div>
                                                    
                                                    {debugMode && (
                                                        <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs">
                                                            <div className="font-bold mb-2">Debug - Texto processado:</div>
                                                            <pre className="whitespace-pre-wrap break-words max-h-40 overflow-y-auto">{opp.fullSection}</pre>
                                                        </div>
                                                    )}
                                                    
                                                    <div className="space-y-3">
                                                        <div className="flex items-start gap-3">
                                                            <Building2 />
                                                            <div className="flex-1">
                                                                <div className="text-xs font-semibold text-gray-500 mb-1">Orgao Licitante</div>
                                                                <div className="text-gray-800 font-medium">{opp.orgao}</div>
                                                            </div>
                                                        </div>

                                                        <div className="flex items-start gap-3">
                                                            <FileText />
                                                            <div className="flex-1">
                                                                <div className="text-xs font-semibold text-gray-500 mb-1">Objeto</div>
                                                                <div className="text-gray-800">{opp.objeto}</div>
                                                            </div>
                                                        </div>

                                                        <div className="flex items-start gap-3">
                                                            <Calendar />
                                                            <div className="flex-1">
                                                                <div className="text-xs font-semibold text-gray-500 mb-1">Prazo Abertura</div>
                                                                <div className="text-gray-800 font-medium">{opp.prazo}</div>
                                                            </div>
                                                        </div>

                                                        <div className="flex items-start gap-3">
                                                            <MapPin />
                                                            <div className="flex-1">
                                                                <div className="text-xs font-semibold text-gray-500 mb-1">Cidade</div>
                                                                <div className="text-gray-800 font-medium">{opp.cidade}</div>
                                                            </div>
                                                        </div>

                                                        {opp.editalLink && (
                                                            <div className="flex items-start gap-3">
                                                                <Link />
                                                                <div className="flex-1">
                                                                    <div className="text-xs font-semibold text-gray-500 mb-1">Arquivo do Edital</div>
                                                                    <a 
                                                                        href={opp.editalLink} 
                                                                        target="_blank" 
                                                                        rel="noopener noreferrer"
                                                                        className="text-purple-600 hover:text-purple-800 underline break-all"
                                                                    >
                                                                        {opp.editalLink}
                                                                    </a>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<EmailAnalyzer />, document.getElementById('root'));
    </script>
</body>
</html>
